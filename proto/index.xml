<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="assets/xsltforms/xsltforms.xsl" type="text/xsl"?>
<html
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xf:bogus="fix/Firefox/namespace/issue"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xs:bogus="fix/Firefox/namespace/issue"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    xlink:bogus="fix/Firefox/namespace/issue"
    xmlns:tei="http://www.tei-c.org/ns/1.0"
    tei:bogus="fix/Firefox/namespace/issue"
    lang="fr">
    <head>
        <meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover"/>
        <title>review-workflow</title>
        <link rel="stylesheet" href="assets/css/main.css"/>
        <xf:model id="review">
            <xf:instance id="text" src="ex_tei.xml"/>

            <xf:instance id="choice">
                <choice xmlns="http://www.tei-c.org/ns/1.0" xml:id="">
                    <sic xml:id=""/> 
                </choice>
            </xf:instance>

            <xf:instance id="apparatus">
                <choice xmlns="http://www.tei-c.org/ns/1.0" xml:id="">
                    <sic xml:id=""/>
                    <corr xml:id=""/>
                </choice>
            </xf:instance>

            <xf:instance id="processing">
                <idno xmlns="http://www.tei-c.org/ns/1.0"/>
            </xf:instance>

            <xf:action ev:event="callbackevent">

 <!-- Remise à zéro de l'instance choice --> 
<xf:delete nodeset="instance('choice')/*"/>
    <xf:insert origin="instance('apparatus')/tei:sic" context="instance('choice')" nodeset="*"/> 


                <xf:setvalue ref="instance('choice')/@xml:id" value="event('choice')"/>
                <xf:setvalue ref="instance('choice')/tei:sic/@xml:id" value="event('sic')"/>
                <xf:insert origin="instance('text')//tei:choice[contains(@corresp, '#subst')][@xml:id = event('choice')]/*[@xml:id = event('sic')]/node()" context="instance('choice')/tei:sic" />

                <xf:action while="count(instance('text')//tei:choice[contains(@corresp, '#subst')][@xml:id = event('choice')]/*[@xml:id[not(. = instance('choice')//@xml:id)]]) > 0">
                    <xf:insert origin="instance('apparatus')/tei:corr" context="instance('choice')" nodeset="*" at="last()"/>
                    <xf:var name="corr" value="instance('text')//tei:choice[contains(@corresp, '#subst')][@xml:id = event('choice')]/*/@xml:id[not(. = instance('choice')//@xml:id)][1]"/>
                    <xf:setvalue ref="instance('processing')" value="$corr" />
                    <xf:setvalue ref="instance('choice')/tei:corr[@xml:id = '']/@xml:id" value="$corr"/>
                    <xf:insert context="instance('choice')/tei:corr[@xml:id = instance('processing')]" origin="instance('text')//tei:choice[contains(@corresp, '#subst')][@xml:id = event('choice')]/*[@xml:id = instance('processing')]/node()"/>
                </xf:action>

                <xf:delete nodeset="instance('text')//tei:choice[contains(@corresp, '#subst')][@xml:id = event('choice')]/*"/>
                <xf:insert origin="instance('choice')/node()" context="instance('text')//tei:choice[contains(@corresp, '#subst')][@xml:id = event('choice')]" />
            </xf:action>
        </xf:model>
    </head>
    <body>
        <h1>Reviewer</h1>
        <xf:trigger>
            <xf:label>Rev</xf:label>
            <xf:toggle case="rev" ev:event="DOMActivate"/>
        </xf:trigger>
        <xf:trigger>
            <xf:label>Check</xf:label>
            <xf:toggle case="check" ev:event="DOMActivate"/>
        </xf:trigger>
        <xf:trigger>
            <xf:label>Read</xf:label>
            <xf:toggle case="read" ev:event="DOMActivate"/>
        </xf:trigger>


        <xf:switch>
            <xf:case id="rev">
                <div>
                    <h2>Text</h2>
                    <xf:output incremental="true" value="transform(instance('text'), 'assets/xsl/teitohtml.xsl', false)" mediatype="text/html"/>
                </div>
            </xf:case>
            <xf:case id="read">
                <xf:output incremental="true" value="transform(instance('text'), 'assets/xsl/teitohtml2.xsl', false)" mediatype="text/html"/>
            </xf:case>
            <xf:case id="check">
                <xf:output incremental="true" value="transform(instance('text'), 'assets/xsl/teitohtml3.xsl', false)" mediatype="text/html"/>
            </xf:case>
        </xf:switch>
        <div>
            <h2>Debug</h2>

            <xf:output value="serialize(instance('text'))"/>
            <xf:output value="serialize(instance('choice'))"/>
            <xf:output value="serialize(instance('processing'))"/>
        </div>
        <script type="text/javascript" src="assets/js/function.js">/**/</script>
    </body>
</html>
